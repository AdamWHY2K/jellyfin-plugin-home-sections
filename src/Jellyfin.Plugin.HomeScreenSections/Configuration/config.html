<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <title>Home Screen Sections</title>
</head>
<body>
<div data-role="page" id="homeScreenSectionsConfigurationPage" class="page type-interior pluginConfigurationPage fullWidthContent">
    <div class="content-primary">
        <div class="verticalSection">
            <div class="sectionTitleContainer">
                <h2 class="sectionTitle">Home Screen Sections</h2>
                <a is="emby-linkbutton" class="raised raised-mini emby-button" style="margin-left: 2em;" target="_blank" href="https://github.com/IAmParadox27/jellyfin-plugin-home-sections">
                    <i class="md-icon button-icon button-icon-left secondaryText"></i>
                    <span>Help</span>
                </a>
            </div>
        </div>
        <hr class="solid">
        <form class="artworkConfigurationForm">
            <fieldset class="verticalSection-extrabottompadding">
                <legend>Global Settings</legend>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="globalEnabledDefault" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                        <span class="checkboxLabel">Enabled by Default</span>
                        <span class="checkboxOutline">
                            <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                            <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                        </span>
                    </label>
                    <div class="fieldDescription">Is Home Screen Sections enabled by default for all users?</div>
                </div>
                <div class="checkboxContainer checkboxContainer-withDescription">
                    <label class="emby-checkbox-label">
                        <input id="globalAllowUserOverride" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                        <span class="checkboxLabel">Allow User Override</span>
                        <span class="checkboxOutline">
                            <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                            <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                        </span>
                    </label>
                    <div class="fieldDescription">Is the user allowed to enable/disable this plugin for their view?</div>
                </div>
            </fieldset>
            <fieldset class="verticalSection-extrabottompadding">
                <legend>Section Settings</legend>
                <div id="sectionWrapper" class="checkboxContainer checkboxContainer-withDescription">
                </div>
            </fieldset>
            <br>
            <button id="btnSaveConfig" is="emby-button" type="submit" class="raised button-submit block emby-button">
                <span>Save</span>
            </button>
        </form>
    </div>
    
    <template id="sectionConfigTemplate">
        <fieldset class="verticalSection-extrabottompadding" data-id="section-config">
            <legend data-id="lblSectionName"></legend>
            <input type="hidden" data-id="hiddenSectionId" />
            <div class="checkboxContainer checkboxContainer-withDescription">
                <label class="emby-checkbox-label">
                    <input id="templateSectionEnabled" data-id="chkSectionEnabled" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                    <span class="checkboxLabel">Enabled</span>
                    <span class="checkboxOutline">
                        <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                        <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                    </span>
                </label>
                <div class="fieldDescription">Is this section enabled by default?</div>
            </div>
            <div class="checkboxContainer checkboxContainer-withDescription">
                <label class="emby-checkbox-label">
                    <input id="templateSectionAllowUserOverride" data-id="chkSectionUserOverrideAllowed" type="checkbox" is="emby-checkbox" data-embycheckbox="true" class="emby-checkbox">
                    <span class="checkboxLabel">Allow User Override</span>
                    <span class="checkboxOutline">
                        <span class="material-icons checkboxIcon checkboxIcon-checked check" aria-hidden="true"></span>
                        <span class="material-icons checkboxIcon checkboxIcon-unchecked " aria-hidden="true"></span>
                    </span>
                </label>
                <div class="fieldDescription">Is the user allowed to enable/disable this section?</div>
            </div>
            <div class="inputContainer">
                <span>View Mode: </span>
                <select is="emby-select" class="emby-select-withcolor emby-select" data-id="viewModeSelect">
                    <option value="Portrait">Portrait</option>
                    <option value="Landscape">Landscape</option>
                    <option value="Square">Square</option>
                </select>
                <span>What shape should the cards appear as when results are loaded. <i>When this field is disabled, it means the section only supports the shape displayed.</i></span>
            </div>
            <div class="inputContainer">
                <label class="inputLabel inputLabelUnfocused" for="templateSectionMinLimit">Lower Limit</label>
                <label class="inputLabel inputLabelUnfocused" for="templateSectionMinLimit"></label>
                <input id="templateSectionMinLimit" data-id="txtSectionMinLimit" type="number" is="emby-input" min="0" class="emby-input">
                <div class="fieldDescription">What is the minimum number of this section that should appear?</div>
            </div>
            <div class="inputContainer">
                <label class="inputLabel inputLabelUnfocused" for="templateSectionMaxLimit">Upper Limit</label>
                <label class="inputLabel inputLabelUnfocused" for="templateSectionMaxLimit"></label>
                <input id="templateSectionMaxLimit" data-id="txtSectionMaxLimit" type="number" is="emby-input" min="0" class="emby-input">
                <div class="fieldDescription">What is the maximum number of this section that should appear?</div>
            </div>
        </fieldset>
    </template>

    <script type="text/javascript">
        if (typeof HomeScreenSections == 'undefined') {

            const HomeScreenSections = {
                pluginId: 'b8298e01-2697-407a-b44d-aa8dc795e850',
                sectionTemplate: document.querySelector('#sectionConfigTemplate'),
                sectionWrapper: document.querySelector('#sectionWrapper'),
                btnSave: document.querySelector('#btnSaveConfig'),
                init: function () {
                    HomeScreenSections.loadConfig();
                },
                saveConfig: function (e) {
                    e.preventDefault();
                    Dashboard.showLoadingMsg();
                    const config = {
                        Enabled: document.querySelector('#globalEnabledDefault').checked,
                        AllowUserOverride: document.querySelector('#globalAllowUserOverride').checked,
                        SectionSettings: []
                    };
                    
                    const configs = document.querySelectorAll('[data-id=section-config]');
                    for (let i = 0; i < configs.length; i++) {
                        const sectionConfig = {
                            SectionId: configs[i].querySelector('[data-id=hiddenSectionId]').value,
                            Enabled: configs[i].querySelector('[data-id=chkSectionEnabled]').checked,
                            AllowUserOverride: configs[i].querySelector('[data-id=chkSectionUserOverrideAllowed]').checked,
                            LowerLimit: configs[i].querySelector('[data-id=txtSectionMinLimit]').value,
                            UpperLimit: configs[i].querySelector('[data-id=txtSectionMaxLimit]').value,
                            ViewMode: configs[i].querySelector('[data-id=viewModeSelect]').value
                        };
                        
                        config.SectionSettings.push(sectionConfig);
                    }
                    
                    window.ApiClient.updatePluginConfiguration(HomeScreenSections.pluginId, config)
                        .then(Dashboard.processPluginConfigurationUpdateResult)
                        .catch(function (error) {
                            console.log(error);
                        })
                        .finally(function () {
                            Dashboard.hideLoadingMsg();
                        });
                },
                loadConfig: function() {
                    Dashboard.showLoadingMsg();
                    window.ApiClient.getPluginConfiguration(HomeScreenSections.pluginId)
                        .then(function (config) {
                            document.querySelector('#globalEnabledDefault').checked = config.Enabled;
                            document.querySelector('#globalAllowUserOverride').checked = config.AllowUserOverride;
                            
                            // Get plugin defaults for each section it defines
                            // Loop over these sections and add in what the config has overwritten
                            let urlStart = window.location.protocol + '//' + window.location.host;
                            window.ApiClient.ajax({
                                url: urlStart + '/ModularHomeViews/Sections',
                                type: 'GET'
                            }).then(function (response) {
                                response.json().then(function (json) {
                                    HomeScreenSections.loadConfigResponse(config, json.Items);
                                });
                            })
                            .catch(function (error) {
                                console.error(error);
                            })
                            .finally(function () {
                                Dashboard.hideLoadingMsg();
                            });
                        });
                },
                loadConfigResponse: function(pluginConfig, sectionTypes) {
                    // clear the "sections"
                    for (let i = 0; i < sectionTypes.length; ++i) {
                        let found = false;
                        for (let j = 0; j < pluginConfig.SectionSettings.length; ++j) {
                            if (pluginConfig.SectionSettings[j].SectionId == sectionTypes[i].Section) {
                                HomeScreenSections.addSectionSetting(pluginConfig.SectionSettings[j], sectionTypes[i]);
                                found = true;
                            }
                        }
                        
                        if (!found) {
                            let newConfig = {
                                SectionId: sectionTypes[i].Section,
                                Enabled: true,
                                AllowUserOverride: true,
                                LowerLimit: 1,
                                UpperLimit: sectionTypes[i].Limit,
                            };
                            
                            HomeScreenSections.addSectionSetting(newConfig, sectionTypes[i]);
                        }
                    }
                    
                },
                addSectionSetting: function(sectionConfig, sectionInfo) {
                    const template = HomeScreenSections.sectionTemplate.cloneNode(true).content;
                    template.querySelector('[data-id=hiddenSectionId]').value = sectionConfig.SectionId;
                    template.querySelector('[data-id=chkSectionEnabled]').checked = sectionConfig.Enabled;
                    template.querySelector('[data-id=chkSectionUserOverrideAllowed]').checked = sectionConfig.AllowUserOverride;
                    template.querySelector('[data-id=txtSectionMinLimit]').value = sectionConfig.LowerLimit;
                    template.querySelector('[data-id=txtSectionMaxLimit]').value = sectionConfig.UpperLimit;
                    template.querySelector('[data-id=viewModeSelect]').value = sectionConfig.ViewMode;
                    if (!sectionInfo.AllowViewModeChange) {
                        template.querySelector('[data-id=viewModeSelect]').value = sectionInfo.ViewMode;
                        template.querySelector('[data-id=viewModeSelect]').setAttribute('disabled', true)
                    }
                    
                    template.querySelector('[data-id=lblSectionName]').innerHTML = sectionInfo.DisplayText;
                    
                    const el = HomeScreenSections.sectionWrapper.appendChild(template);
                }
            }

            document.querySelector('#homeScreenSectionsConfigurationPage').addEventListener("pageshow", function () {
                HomeScreenSections.btnSave.addEventListener("click", HomeScreenSections.saveConfig);
                HomeScreenSections.init();
            });
        }
    </script>
</div>
</body>
</html>